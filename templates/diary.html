{% extends "base.html" %}

{% block content %}
<div class="glass journal-form">
    <h2>Journal Entry for {{ today.strftime('%B %d') }}</h2>

    <form action="{{ url_for('diary') }}" method="POST" enctype="multipart/form-data">
        <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ðŸ“Œ Pin a thought or focus</label>
            <input id="pinned-input" type="text" name="pinned_text" value="{{ entry.pinned_text if entry else '' }}"
                placeholder="e.g., Calculated indifference to minor annoyances."
                style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(15,23,42,0.5); color: white;">
        </div>

        <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Dear Diary...</label>
            <textarea id="content-input" name="content"
                placeholder="How did the day go?">{{ entry.content if entry else '' }}</textarea>
            <p id="save-status"
                style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; min-height: 1.2rem;"></p>
        </div>

        <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">ðŸ“¸ Photos</label>

            <!-- Drag and Drop Upload Zone -->
            <div id="upload-zone" class="glass"
                style="border: 2px dashed var(--glass-border); border-radius: 12px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s; position: relative;">
                <input type="file" id="photo-input" multiple accept="image/*" style="display: none;">
                <div id="upload-prompt">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">âž•</div>
                    <p style="color: var(--text-muted); margin: 0;">Click or drag photos here</p>
                    <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem;">Upload instantly
                        without saving entry</p>
                </div>
                <div id="upload-status" style="display: none; color: var(--success);"></div>
            </div>

            <!-- Current Album Display -->
            {% if entry and entry.images %}
            <div class="mt-4"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem;">
                <p style="grid-column: 1/-1; font-weight: 500; color: var(--text-muted);">Current Album ({{
                    entry.images|length }})</p>
                {% for img in entry.images %}
                <div style="position: relative;">
                    <img src="{{ url_for('static', filename='uploads/' + img.image_path) }}"
                        style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px; border: 1px solid var(--glass-border);">
                    <form action="{{ url_for('delete_photo', image_id=img.id) }}" method="POST"
                        style="position: absolute; top: -5px; right: -5px;"
                        onsubmit="return confirm('Delete this photo?');">
                        <button type="submit"
                            style="background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px; cursor: pointer;">Ã—</button>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <script>
            const uploadZone = document.getElementById('upload-zone');
            const photoInput = document.getElementById('photo-input');
            const uploadPrompt = document.getElementById('upload-prompt');
            const uploadStatus = document.getElementById('upload-status');
            const today = '{{ today.isoformat() }}';

            // Click to upload
            uploadZone.addEventListener('click', () => photoInput.click());

            // Drag and drop
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--primary)';
                uploadZone.style.background = 'rgba(139, 92, 246, 0.1)';
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.style.borderColor = 'var(--glass-border)';
                uploadZone.style.background = 'transparent';
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--glass-border)';
                uploadZone.style.background = 'transparent';

                const files = e.dataTransfer.files;
                uploadFiles(files);
            });

            photoInput.addEventListener('change', (e) => {
                uploadFiles(e.target.files);
            });

            function uploadFiles(files) {
                if (files.length === 0) return;

                const formData = new FormData();
                formData.append('date', today);

                for (let file of files) {
                    formData.append('photos', file);
                }

                // Show uploading status
                uploadPrompt.style.display = 'none';
                uploadStatus.style.display = 'block';
                uploadStatus.textContent = `Uploading ${files.length} photo(s)...`;

                fetch('/photo/upload', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            uploadStatus.textContent = `âœ“ ${data.count} photo(s) uploaded!`;
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    })
                    .catch(error => {
                        uploadStatus.textContent = 'âœ— Upload failed';
                        uploadStatus.style.color = 'var(--danger)';
                        setTimeout(() => {
                            uploadPrompt.style.display = 'block';
                            uploadStatus.style.display = 'none';
                        }, 2000);
                    });
            }
        </script>

        <script>
            // Auto-save functionality
            const pinnedInput = document.getElementById('pinned-input');
            const contentInput = document.getElementById('content-input');
            const saveStatus = document.getElementById('save-status');
            const diaryDate = '{{ today.isoformat() }}';

            let saveTimeout;
            let isSaving = false;

            function autoSave() {
                if (isSaving) return;

                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    isSaving = true;
                    saveStatus.textContent = 'Saving...';
                    saveStatus.style.color = 'var(--text-muted)';

                    const formData = new FormData();
                    formData.append('date', diaryDate);
                    formData.append('pinned_text', pinnedInput.value);
                    formData.append('content', contentInput.value);

                    fetch('/diary/save', {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                saveStatus.textContent = 'âœ“ Saved';
                                saveStatus.style.color = 'var(--success)';
                                setTimeout(() => {
                                    saveStatus.textContent = '';
                                }, 2000);
                            }
                            isSaving = false;
                        })
                        .catch(error => {
                            saveStatus.textContent = 'âœ— Save failed';
                            saveStatus.style.color = 'var(--danger)';
                            isSaving = false;
                        });
                }, 1000); // Debounce for 1 second
            }

            pinnedInput.addEventListener('input', autoSave);
            contentInput.addEventListener('input', autoSave);
        </script>
</div>
{% endblock %}